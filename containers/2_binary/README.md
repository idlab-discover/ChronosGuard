# Anomaly Detection API

The anomaly detection api builds further with the result of the **Preprocessing API** and classifies a flow as `Benign` or `Attack`. When a `Attack` is detected the flow is forwarded to **Multi-Class Classifier**.

## API Endpoints

| HTTP Method | Endpoint   | Description                             |
|-------------|------------|-----------------------------------------|
| POST        | `/predict` | Run the ML pipeline for a preprocessed flow.   |
| GET         |        `/` | Healthcheck                             |
| GET         |    `/docs` | OpenAPI documentation                   |

### Predict samples using the API

The API expects a HTTP POST request with a JSON body containing two lists with the scaled 67 features as `float` and optional `timestamps` for the event time and processing timestamps.

```` bash
curl --location --request POST 'http://localhost:8001/predict' \
--header 'Content-Type: application/json' \
--data-raw '{
    "event_timestamp": "2022-08-10T12:53:56+00:00",
    "processing_timestamp_start": "2022-08-10T12:53:56.527624",
    "processing_timestamp_end": "2022-08-10T12:53:56.639806",
    "features_1": [ -0.5598590598576754, -2.0232920792351936, -0.13844353805389234, -5.199337582605575, -0.7563331967496455, -5.199337582605575, -0.8284646485811346, 0.012546016181542559, -0.8039576712814882, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, 1.8312243273394455, 2.2258232069243142, -1.934488838631409, -5.199337582605575, -2.00423357987982, -0.45424895715848407, -0.3295477057744347, -0.31501172334262695, -5.199337582605575, -0.3268997056244447, -0.07912030015842841, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -0.4459191404420153, -5.199337582605575, 2.256744846946742, -5.199337582605575, 0.027604016757951728, -0.8735150946146939, -0.8004960979745592, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, 5.19933758270342, -5.199337582605575, -5.199337582605575, -5.199337582605575, -0.7680753131709815, -0.8039576712814882, -5.199337582605575, -0.13844353805389234, -0.7563331967496455, -5.199337582605575, -5.199337582605575, 0.34129131597603285, -5.199337582605575, 0.026348991391809306, -0.6363865203698571, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575 ],
    "features_2": [ -5.199337582605575, -2.651731984747387, -0.4878930103874749, -5.199337582605575, 0.06151263655249807, -5.199337582605575, 0.005018295886876199, 1.6113332511692402, 0.010036718154949801, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, 2.696511062787801, 2.7474533189644763, -2.651731984747387, -5.199337582605575, -2.651731984747387, -0.8901723046231351, -0.563955207252462, -0.563955207252462, -5.199337582605575, -0.563955207252462, -0.23035256480696298, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -0.7168389528871792, -5.199337582605575, 2.9348890362047704, -5.199337582605575, 1.634746967913314, -0.3110590177663439, 0.01881964145130391, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, 5.19933758270342, -5.199337582605575, -5.199337582605575, -5.199337582605575, 0.05522908732975672, 0.010036718154949801, -5.199337582605575, -0.4878930103874749, 0.06151263655249807, -5.199337582605575, -5.199337582605575, -0.6206232306893864, -5.199337582605575, 0.236798889881903, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575, -5.199337582605575 ]
}'
````

## Environment variables

`MODEL_MULTI_CLASS_HOST`
: The host address of the `Multi-Class Classifier` in the following format: `http://<IP>:<PORT>`
**Default**: "http://multi_class_api:8002"

`MODEL_TAU_B`
: The used threshold on the anomaly score to differentiate `Benign` from `Attack`.
**Default**: -0.0002196942507948895

`MODEL_HTTPX_TIMEOUT`
: The http timeout used to call the next service in the chain.
**Default**: 60 (s

### Uvicorn Environment Variables

Uvicorn is used as underlying ASGI web server and can be configured using environment variables with the prefix `UVICORN_`.

`UVICORN_HOST`
: Bind socket to this host. IPv6 addresses are supported, for example `::`
**Default**: "127.0.0.1"

`UVICORN_PORT`
: Bind socket with this port.
**Default**: "8000"

`UVICORN_WORKERS`
: Use multiple worker processes.
**Default**: "1"

For all available configuration options: see [Uvicorn Configuration](https://www.uvicorn.org/settings/).

## Build image

`docker build -t binary_api .`

## Run image

`docker run -it --rm -p8000:8000 binary_api`
